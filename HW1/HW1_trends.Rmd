---
title: "HW1: Sequoia NP Climate Trends"
author: "Nick McManus"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(lubridate)
library(Kendall)
```


```{r}
### read in data
seq_clim <- read_csv("AshMt_GHCND_1927_2020.csv") %>% 
  janitor::clean_names()

### make sure date is correct class
as.Date(seq_clim$date)
# class(seq_clim$date)

```


### Running basic quality checks
Now that we've read in the data, the next step is quality checking! Let's make a plot to see what data are missing.

```{r dailyplots, echo=TRUE}
#### Max air temp -------------------------------------
## plot
ggplot(seq_clim, aes(date, tmax)) +
  geom_line() + 
  labs(y="Daily Maximum Temperature (degrees F)", x="Date")

## number of NAs
  # sum(is.na(seq_clim$tmax))
  # [1] 279
  # (sum(is.na(seq_clim$tmax)))/(count(seq_clim))
  # 0.008270342	


### Min air temp
## plot
ggplot(seq_clim, aes(date, tmin))+
  geom_line() + 
  labs(y="Daily Minimum Temperature (degrees F)", x="Date")

## number of NAS
  # sum(is.na(seq_clim$tmin))
  # [1] 322
  # (sum(is.na(seq_clim$tmin)))/(count(seq_clim))
  # 0.009544983


### Precip ---------------------------------------------
## plot
ggplot(seq_clim, aes(date, prcp)) +
  geom_line() + 
  labs(y="Daily Rainfall (in)", x="Date")

## number of NAS
  # sum(is.na(seq_clim$prcp))
  # [1] 1136
  # (sum(is.na(seq_clim$prcp)))/(count(seq_clim))
  # 0.03367423	
```


Not a crazy amount of NAs for temp, so going to fill them in with some assumptions
```{r}
### max temp
## values are either NA or not reasonable for that location (here, below 30F)
fillrow = which(is.na(seq_clim$tmax) | seq_clim$tmax <= 30)
fillrow = fillrow[2:length(fillrow)]
seq_clim$tmax[fillrow]=(seq_clim$tmax[fillrow+1]+seq_clim$tmax[fillrow-1])/2
ggplot(seq_clim, aes(date, seq_clim$tmax))+geom_line()+ labs(y="Daily Maximum Temperature (degrees F)", x="Date")

### min temp
## appears that there is at least one min temp value that is incorrect
fillrow = which(is.na(seq_clim$tmin) | seq_clim$tmin <= 15)
fillrow = fillrow[2:length(fillrow)]
seq_clim$tmin[fillrow]=(seq_clim$tmin[fillrow+1]+seq_clim$tmin[fillrow-1])/2
ggplot(seq_clim, aes(date, seq_clim$tmin))+geom_line()+ labs(y="Daily Maximum Temperature (degrees F)", x="Date")
```

Too many NAs for precip, and some span for large segments of the year. It *might* be safe to assume that these indicate no precipitation, but could be due to station functionality. For hot days, especially in summer, it is likely safe to assume that no precipitation occured. We'll fill in 0 for NA values in days above 70 degrees F, and leave the rest as NAs to be conservative. 
```{r}
fillrow = which((is.na(seq_clim$prcp)) & seq_clim$tmax >= 70)
## fill in data in the missing rows with zeros
seq_clim$prcp[fillrow]=0
## replot to make sure it works
ggplot(seq_clim, aes(date, prcp))+geom_line()+ labs(y="Daily rainfall (mm)", x="Date")

### Check the new number of NAs
  # sum(is.na(seq_clim$prcp))
  # [1] 276
```



### Looking for Trends

Now that the data has been cleaned up, it's time to actually do the trend analysis. BUT, trends can be 'swamped' by variation; in this case, the seasonal cycle is quite large. We also need to consider autocorrelation! 

So here let's try doing some aggregation to reduce the noise. As a simple example, we can try annual averages.

```{r annual, echo=TRUE}
### Find avg min and max temps and total precip by year
seq_clim_trend <- seq_clim %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(year) %>% 
  summarize(tmax_avg = mean(tmax, na.rm = F),
            tmin_avg = mean(tmin, na.rm = F),
            precip = sum(prcp))

### Plot values
ggplot(seq_clim_trend, aes(x = year, y = tmax_avg)) +
  geom_point(col="red") +
  scale_y_continuous(limits = c(min(seq_clim_trend$tmin_avg), max(seq_clim_trend$tmax_avg))) +
  geom_point(data = seq_clim_trend, aes(x = year, tmin_avg), col="blue")



a = ggplot(seq_clim_trend, aes(x=year, tmax_avg)) +
  geom_point(col="red") +
  scale_y_continuous(limits=c(min(seq_clim_trend$tmin_avg), max(seq_clim_trend$tmax_avg))) +
  geom_point(data=seq_clim_trend, aes(x=year, tmin_avg), col="blue")

# now lets add a trendd line
a = a + stat_smooth(method="lm", col="red")
a
a + stat_smooth(data=seq_clim_trend, aes(x=year,tmin_avg), col="blue", method="lm")

```

Now let's calculate the slope (or how quickly temperatures are rising; we do this with linear regression)

```{r regressionline, echo=TRUE}


res=lm(tmin_avg~year, data=seq_clim_trend)
summary(res)
confint(res,"year", level=0.95)
ggplot(seq_clim_trend, aes(x=year, y=tmin_avg)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")
```










